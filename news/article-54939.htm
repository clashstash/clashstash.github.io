<!DOCTYPE html>
<html xml:lang="zh-CN" lang="zh-CN">

<head>
        <link rel="canonical" href="https://clashstash.github.io/news/article-54939.htm" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>进程通信&#8212;-共享内存以及mmap函数实现共享内存</title>
        <meta name="description" content="进程间通信----共享内存   最底层的原理：让不同的进程看到相同的物理资源（将不同进程的 虚拟内存地址 映射到 同一块相同的物理内存上）   对共享内存的操作没有进行检测 PV操作需要用户自己来完成" />
        <link rel="icon" href="/assets/website/img/clashstash/favicon.ico" type="image/x-icon"/>

    <meta name="author" content="ClashStash官方节点站">
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://clashstash.github.io/news/article-54939.htm" />
    <meta property="og:site_name" content="ClashStash官方节点站" />
    <meta property="og:title" content="进程通信&#8212;-共享内存以及mmap函数实现共享内存" />
    <meta property="og:image" content="https://clashstash.github.io/uploads/20240709/9a59164aa14fa2ff70e4ee3d5cf7db5d.webp" />
        <meta property="og:release_date" content="2025-02-11T05:44:29" />
    <meta property="og:updated_time" content="2025-02-11T05:44:29" />
        <meta property="og:description" content="进程间通信----共享内存   最底层的原理：让不同的进程看到相同的物理资源（将不同进程的 虚拟内存地址 映射到 同一块相同的物理内存上）   对共享内存的操作没有进行检测 PV操作需要用户自己来完成" />
        
    <link rel="stylesheet" href="/assets/website/css/clashstash/maicons.css">
    <link rel="stylesheet" href="/assets/website/css/clashstash/bootstrap.css">
    <link rel="stylesheet" href="/assets/website/css/clashstash/theme.css">

    <meta name="applicable-device" content="pc,mobile" />
    <meta name="renderer" content="webkit" />
    <meta name="force-rendering" content="webkit" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta name="robots" content="max-image-preview:large" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="进程通信&#8212;-共享内存以及mmap函数实现共享内存">
    <meta name="format-detection" content="telephone=no">

    <link rel="dns-prefetch" href="https:/www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.googleadservices.com">
    <link rel="dns-prefetch" href="https://www.google-analytics.com">
    <link rel="dns-prefetch" href="https://pagead2.googlesyndication.com">
    <link rel="dns-prefetch" href="https://cm.g.doubleclick.net">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FGG26WJLQX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FGG26WJLQX');
</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3332997411212854"
     crossorigin="anonymous"></script>
</head>

<body data-page="detail">
    <!-- Back to top button -->
    <div class="back-to-top"></div>
    <header>
                <nav class="navbar navbar-expand-lg navbar-light bg-white sticky" data-offset="500">
            <div class="container">
                                <a href="/" class="navbar-brand">Clash<span class="text-primary">Stash</span></a>
                                <button class="navbar-toggler" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse" id="navbarContent">
                    <ul class="navbar-nav ml-auto">
                                                <li class="nav-item">
                            <a class="nav-link" href="/">首页</a>
                        </li>
                                                <li class="nav-item">
                            <a class="nav-link" href="/free-nodes/">免费节点</a>
                        </li>
                                                <li class="nav-item">
                            <a class="nav-link" href="/paid-subscribe/">推荐机场</a>
                        </li>
                                                <li class="nav-item">
                            <a class="nav-link" href="/client.htm">客户端</a>
                        </li>
                                                <li class="nav-item">
                            <a class="nav-link" href="/news/">新闻资讯</a>
                        </li>
                                            </ul>
                </div>
            </div>
        </nav>
        <div class="container">
            <div class="page-banner">
                <div class="row justify-content-center align-items-center h-100">
                    <div class="col-md-6">
                        <nav aria-label="Breadcrumb">
                            <ul class="breadcrumb justify-content-center py-0 bg-transparent">
                                <li class="breadcrumb-item"><a href="/">首页</a></li>
                                <li class="breadcrumb-item"><a href="/news/">新闻资讯</a></li>
                                <li class="breadcrumb-item active">正文</li>
                            </ul>
                        </nav>
                        <h1 class="text-center">进程通信&#8212;-共享内存以及mmap函数实现共享内存</h1>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="page-section" id="about">
        <div class="container">
            <div class="row">
                <div class="col-md-9">
                                    <input type="hidden" id="share-website-info" data-name="" data-url="">
                  				  				  				<div id="content_views" class="htmledit_views"> <div class="artical-content-bak main-content editor-side-new"> <div class="con editor-preview-side" id="result"> <p>进程间通信----共享内存</p> <ul class="list-paddingleft-2"> <li> <p>最底层的原理：让不同的进程看到相同的物理资源（将不同进程的 虚拟内存地址 映射到 同一块相同的物理内存上）</p> </li> <li> <p>对共享内存的操作没有进行检测 PV操作需要用户自己来完成</p> </li> <li> <p>对共享内存的操作 执行向上取整 按页申请 （如一页不够就用两页 但用户可以使用的 还是他自己申请的那么大 如申请4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg97B 实际申请8kB 但用户只能用4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg97B【一页4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96B】）</p> </li> <li> <p>生命周期随内核 不随进程（进程退出 进程不主动删除 共享内存 &nbsp;则共享内存还在）</p> </li> </ul> <p><span style="font-family:'微软雅黑', 'Microsoft YaHei';"><a href="http://img.555519.xyz/uploads3/2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg22http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg9http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg5/333df554e9ba6http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgcfehttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgd3http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg9a4ba616f6.jpg" rel="nofollow" class="fancybox" data-fancybox-group="button"><img decoding="async" src="http://img.555519.xyz/uploads3/2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg22http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg9http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg5/333df554e9ba6http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgcfehttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgd3http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg9a4ba616f6.jpg" alt="进程通信----共享内存以及mmap函数实现共享内存" title="Image.png"></a></span></p> <p>1、用到的函数</p> <ul class="list-paddingleft-2"> <li> <p><strong>int shmget(key_t key, size_t size, int shmflg);</strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;【创建共享内存 | 获得共享内存】</p> </li> </ul> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key: 由ftok()函数返回的标识符</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size：字节为单位所需的共享内存容量</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shmflg：IPC_CREAT</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IPC_EXCL</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IPC_CREAT|IPC_EXCL</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;IPC_CREAT|IPC_EXCL|http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg666</p> <ul class="list-paddingleft-2"> <li> <p><strong>int shmctl(int shmid, int cmd, struct shmid_ds *buf);</strong></p> </li> </ul> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ 控制共享内存]</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shm_id:shmget返回的共享内存标识符</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmd：</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IPC_STAT:把shmid_ds结构中的数据设置为共享内存的当前关联值，即把共享内存的当前设置值保存在shmid_ds中。</p> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IPC_SET:如果进程有足够权限，把共享内存的当前关联值<span style="font-size:14px;">设置为shmid_ds结构中给出的值</span></p> <p><span style="font-size:14px;"><span style="color:rgb(28,51,135);">&nbsp; IPC_RMID :删除共享内存</span></span></p> <p><span style="font-size:14px;"><span style="color:rgb(28,51,135);"><br /></span></span></p> <ul class="list-paddingleft-2"> <li> <p><strong>void *shmat(int shmid, const void *shmaddr, int shmflg);</strong></p> </li> </ul> <p>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at是attach</p> <p>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[挂接*（将创建的共享内存与进程的虚拟内存相关联 让进程可以向操作malloc的空间一样操作共享内存） 使得ipcs -m 中nattch选项加1]</p> <p>返回值可以理解为（当成）malloc申请的资源地址 【其实两个是完全不一样的】</p> <p>&nbsp; &nbsp; &nbsp;成功返回指向共享内存的指针，失败返回-1</p> <p>const void *shmaddr在哪开辟 &nbsp;可以让系统自己决定（NULL）</p> <p>int shmflg 开辟的属性读写权限 可以让系统自己决定（NULL）</p> <ul class="list-paddingleft-2"> <li> <p><strong>int shmdt(const void *shmaddr);</strong></p> </li> </ul> <p>&nbsp; &nbsp; &nbsp; dt是detach[删除挂接 使得ipcs -m 中nattch选项减去1]</p> <p><span style="color:rgb(123,http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,61);">注意： 对共享内存的操作没有进行 先后顺序检测 任何进程都可以操作 要实现互斥 就要自己用信号量进行加锁的 PV操作</span></p> <p>2、查看的命令:</p> <p>ipcs -m</p> <p>写一个监视的脚本</p> <p>while :; do ipcs -m|grep "root"; sleep 1; echo "###########"; done</p> <p><span style="font-family:'微软雅黑', 'Microsoft YaHei';"><a href="http://img.555519.xyz/uploads3/2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg22http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg9http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg5/381c76dd46http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg7ba44f6http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg6c447ed551552.jpg" rel="nofollow" class="fancybox" data-fancybox-group="button"><img decoding="async" src="http://img.555519.xyz/uploads3/2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg22http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg9http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg5/381c76dd46http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg7ba44f6http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg6c447ed551552.jpg" alt="进程通信----共享内存以及mmap函数实现共享内存" title="Imageipcs.png"></a></span></p> <p><span style="font-family:'微软雅黑', 'Microsoft YaHei';"></span></p> <p>3、练习程序</p> <p>------------------------------shm.h--------------------------------------</p> <pre><code class="language-cpp">/*&nbsp;共享内存*/ #pragma&nbsp;once #include&nbsp;&lt;stdio.h&gt; #include&nbsp;&lt;sys/shm.h&gt; #include&nbsp;&lt;sys/ipc.h&gt; #include&nbsp;&lt;unistd.h&gt; #define&nbsp;__PATH__&nbsp;"." #define&nbsp;__PROJECT__&nbsp;1234 #define&nbsp;__SHM_SIZE__&nbsp;(4*1http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg24)&nbsp;//&nbsp;4k对齐 //#define&nbsp;__SHM_SIZE__&nbsp;(5*1http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg24)&nbsp;//&nbsp;4k对齐 int&nbsp;get_shm(); char*&nbsp;at_shm(int&nbsp;shm_id); int&nbsp;delete_shm(void&nbsp;*addr); int&nbsp;rm_shm(int&nbsp;shm_id);</code></pre> <hr/> <p>----------------------------shm.c----------------------------------------</p> <pre><code class="language-cpp">#include&nbsp;"shm.h" //&nbsp;创建&nbsp;shm int&nbsp;get_shm() { &nbsp;&nbsp;&nbsp;&nbsp;key_t&nbsp;key&nbsp;=&nbsp;ftok(__PATH__,__PROJECT__); &nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;flag&nbsp;=&nbsp;IPC_CREAT|IPC_EXCL|http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg666; &nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;shm_id&nbsp;=&nbsp;shmget(key,&nbsp;__SHM_SIZE__,&nbsp;flag); &nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(shm_id&nbsp;==&nbsp;-1) &nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror("shmget&nbsp;error"); &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;else &nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf("creat&nbsp;shm&nbsp;success\n"); &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;shm_id; } char*&nbsp;at_shm(int&nbsp;shm_id) { &nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;挂接shm &nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(char*)shmat(shm_id,&nbsp;NULL,http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg&nbsp;); } //&nbsp;解除&nbsp;挂接 int&nbsp;delete_shm(void&nbsp;*addr) { &nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;shmdt(addr); } //&nbsp;success&nbsp;return&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg&nbsp;&nbsp;&nbsp;error&nbsp;return&nbsp;-1 int&nbsp;rm_shm(int&nbsp;shm_id) { &nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;shmctl(shm_id,&nbsp;IPC_RMID,NULL); }</code></pre> <hr/> <p>----------------------------------------test_shm.c------------------</p> <pre><code class="language-cpp">#include&nbsp;"shm.h" #include&nbsp;&lt;sys/types.h&gt; #include&nbsp;&lt;sys/wait.h&gt; int&nbsp;main() { &nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;shm_id&nbsp;=&nbsp;get_shm(); &nbsp;&nbsp;&nbsp;&nbsp;pid_t&nbsp;id&nbsp;=&nbsp;fork(); &nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(id&nbsp;&lt;&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg) &nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf("fork&nbsp;child&nbsp;error\n"); &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(id&nbsp;==&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg) &nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;child &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(2); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;buf&nbsp;=&nbsp;at_shm(shm_id); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(4); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i&nbsp;=&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(i&nbsp;&lt;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf[i]&nbsp;=&nbsp;'X'; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i++; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf[4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg95]&nbsp;=&nbsp;'\http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg'; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(3); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete_shm(buf); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(3); &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;else &nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;father &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(4); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;buf&nbsp;=&nbsp;at_shm(shm_id); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(2); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf("%s\n",&nbsp;buf); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete_shm(buf); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(2); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//waitpid(id,&nbsp;NULL,&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wait(NULL); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rm_shm(shm_id); &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg; }</code></pre> <p>-------------------------------------运行截图---------------------------------</p> <p><img decoding="async" src="http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg" alt="进程通信----共享内存以及mmap函数实现共享内存" style="background:url(&quot;/e/u261/lang/zh-cn/p_w_picpaths/localp_w_picpath.png&quot;) no-repeat center;border:1px solid #ddd;"></p> <p>监视脚本：</p> <pre class="brush:bash;toolbar:false">[root@localhost&nbsp;bozi]#&nbsp;&nbsp;while&nbsp;:;&nbsp;do&nbsp;ipcs&nbsp;-m&nbsp;|&nbsp;grep&nbsp;root;&nbsp;sleep&nbsp;1;echo&nbsp;"##########";done http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ########## http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgxd2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpghttp://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg649e&nbsp;18http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg2257&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg96&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg</pre> <p><span style="color:rgb(8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg);">&nbsp;首先由父进程创建共享内存，父进程创建子进程，父子进程都关联了共享内存，关联的个数由http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg变为2，因父进程休息时间短，取消关联，关联个数变为1，最后子进程也取消关联，关联个数变为http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg，最后将共享内存销毁。</span></p> <p>4、mmap函数</p> <p><a href="http://baike.baidu.com/link?url=GW7f3zIQ2_5TJEhowcqp8ABwpt45EqZaEZIJpfRxRsvjoXne879http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgebjZ4sDQ6g-J2DFqy3gk3tnI6UsNoUIRwq" rel="nofollow">http://baike.baidu.com/link?url=GW7f3zIQ2_5TJEhowcqp8ABwpt45EqZaEZIJpfRxRsvjoXne879http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpgebjZ4sDQ6g-J2DFqy3gk3tnI6UsNoUIRwq</a></p> <p><span style="color:rgb(8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg);">mmap将一个文件或者其他对象映射进内存。mmap也可以实现共享内存</span>。mmap函数调用使得进程之间通过<strong><span style="color:rgb(255,http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg);">映射同一个文件</span></strong>实现共享内存。文件被映射到进程地址空间后，进程可以像读写内存一样对文件进行操作。</p> <p>函数：</p> <pre><code class="language-cpp">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#include&nbsp;&lt;sys/mman.h&gt; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;*mmap(void&nbsp;*addr,&nbsp;size_t&nbsp;length,&nbsp;int&nbsp;prot,&nbsp;int&nbsp;flags,&nbsp;&nbsp;int&nbsp;fd,&nbsp;off_t&nbsp;offset); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;*mmap64(void&nbsp;*addr,&nbsp;size_t&nbsp;length,&nbsp;int&nbsp;prot,&nbsp;int&nbsp;flags,int&nbsp;fd,&nbsp;off64_t&nbsp;offset); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;munmap(void&nbsp;*addr,&nbsp;size_t&nbsp;length);</code></pre> <p><span style="color:rgb(8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,8http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg);"><span style="font-size:14px;"><span style="font-family:'宋体', 'Arial Narrow', arial, serif;"><br /></span></span></span></p> <p>&nbsp;&nbsp;addr:映射区的开始地址，设置为NULL时表示系统决定映射区的起始地址</p> <p style="clear:both;">&nbsp; length：映射区的长度。长度单位为字节</p> <p style="clear:both;">&nbsp; prot:期望的内存保护标志。取以下几个值：</p> <p style="clear:both;">&nbsp; &nbsp; &nbsp; &nbsp;PORT_EXEC:页内容可以被执行 &nbsp; PORT_READ:页内容可以被读取</p> <p style="clear:both;">&nbsp; &nbsp; &nbsp; &nbsp;PORT_WRITE:页内容可以被写入 &nbsp;PROT_NONE:页内容不可访问</p> <p style="clear:both;">&nbsp; flag：指定映射对象的类型，映射选项与映射页是否可以共享。</p> <p style="clear:both;">&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;MAP_SHARED：与其他所有映射这个对象的进程共享映射空间。</p> <p style="clear:both;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MAP_PRIVATE：建立一个写入时拷贝的私有映射。内存区域的写入不会影响到原文件。</p> <p style="clear:both;"><span style="text-indent:28px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MAP_FIXED ：使用指定的映射起始地址，如果由start和len参数指定的内存区重叠于现存的映射空 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;间，重叠部分将会被丢弃。如果指定的起始地址不可用，操作将会失败。</span></p> <p style="clear:both;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd: 有效的文件描述符。返回，由一般open()函数，其值可以设置为-1.此时需要指定flags参数为 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MAP_ANON,表明进行的是匿名映射。</p> <p style="clear:both;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;offset:被映射对象内容的起点。</p> <p style="clear:both;"> <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;返回值：成功，返回被映射区的指针；失败，返回-1.</p> <p>设备操作：</p> <p><span style="color:rgb(51,51,51);">mmap操作提供了一种机制，让</span><a href="http://www.m6000.cn/wp-content/themes/begin%20lts/inc/go.php?url=http://baike.baidu.com/view/1976812.htm"  style="color:rgb(19,11http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,194);text-decoration:none;" rel="nofollow">用户程序</a><span style="color:rgb(51,51,51);">直接访问设备内存，这种机制，相比较在</span><a href="http://www.m6000.cn/wp-content/themes/begin%20lts/inc/go.php?url=http://baike.baidu.com/view/4274331.htm"  style="color:rgb(19,11http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,194);text-decoration:none;" rel="nofollow">用户空间</a><span style="color:rgb(51,51,51);">和</span><a href="http://www.m6000.cn/wp-content/themes/begin%20lts/inc/go.php?url=http://baike.baidu.com/view/4271323.htm"  style="color:rgb(19,11http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,194);text-decoration:none;" rel="nofollow">内核空间</a><span style="color:rgb(51,51,51);">互相拷贝数据，效率更高。在要求高性能的应用中比较常用。mmap映射内存必须是页面大小的整数倍，面向流的设备不能进行mmap，mmap的实现和硬件有关。</span></p> <p><span style="color:rgb(51,51,51);">结论：</span><span style="color:rgb(51,51,51);font-family:arial, '宋体', sans-serif;font-size:14px;text-indent:28px;"></span></p> <p><span style="color:rgb(51,51,51);font-family:arial, '宋体', sans-serif;font-size:14px;text-indent:28px;">　　1、 最终被映射文件的内容的长度不会超过文件本身的初始大小，即映射不能改变文件的大小；</span><br style="color:rgb(51,51,51);font-family:arial, '宋体', sans-serif;font-size:14px;text-indent:28px;"/><span style="color:rgb(51,51,51);font-family:arial, '宋体', sans-serif;font-size:14px;text-indent:28px;">　　2、可以用于进程通信的有效地址空间大小大体上受限于被映射文件的大小，但不完全受限于文件大小。打开文件被截短为5个people结构大小，而在 map_normalfile1中初始化了1http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg个people数据结构，在恰当时候（map_normalfile1输出initialize over 之后，输出umap ok之前）调用map_normalfile2会发现map_normalfile2将输出全部1http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg个people结构的值，后面将给出详细讨论。</span><br style="color:rgb(51,51,51);font-family:arial, '宋体', sans-serif;font-size:14px;text-indent:28px;"/><span style="color:rgb(51,51,51);font-family:arial, '宋体', sans-serif;font-size:14px;text-indent:28px;">　　注：在linux中，内存的保护是以页为基本单位的，即使被映射文件只有一个字节大小，内核也会为映射分配一个页面大小的内存。当被映射文件小于一个页面大小时，进程可以对从mmap()返回地址开始的一个页面大小进行访问，而不会出错；但是，如果对一个页面以外的地址空间进行访问，则导致错误发生，后面将进一步描述。因此，可用于进程间通信的有效地址空间大小不会超过文件大小及一个页面大小的和。</span></p> <p><span style="color:rgb(51,51,51);font-family:arial, '宋体', sans-serif;font-size:14px;text-indent:28px;">　　3、文件一旦被映射后，调用mmap()的进程对返回地址的访问是对<span style="color:rgb(255,http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg);">某一内存区域的访问，暂时脱离了磁盘上文件的影响</span>。所有对mmap()返回地址空间的操作只在内存中有意义，只有在调用了munmap()后或者msync()时，才把内存中的相应内容写回磁盘文件，所写内容仍然不能超过文件的大小。</span></p> <p>测试代码：</p> <pre><code class="language-cpp">#include&lt;stdio.h&gt; #include&nbsp;&lt;sys/mman.h&gt; #include&nbsp;&lt;sys/types.h&gt; #include&nbsp;&lt;sys/stat.h&gt; #include&nbsp;&lt;fcntl.h&gt; #include&nbsp;&lt;unistd.h&gt; #define&nbsp;_PATH_NAME_&nbsp;"./mmap.tmp" int&nbsp;main() { &nbsp;&nbsp;&nbsp;&nbsp;//int&nbsp;fd&nbsp;=&nbsp;open(_PATH_NAME_,O_RDONLY); &nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;fd&nbsp;=&nbsp;open(_PATH_NAME_,&nbsp;O_RDWR); &nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fd&nbsp;&lt;&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg) &nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf("open&nbsp;error\n"); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1; &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;len&nbsp;=&nbsp;lseek(fd,&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg,&nbsp;SEEK_END);//&nbsp;测文件长度 char*&nbsp;ptr&nbsp;=&nbsp;mmap(NULL,&nbsp;len,&nbsp;PROT_READ|PROT_WRITE,&nbsp;MAP_SHARED,&nbsp;fd,&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg); &nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ptr&nbsp;&lt;&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg) &nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close(fd); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf("mmap&nbsp;error\n"); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-3; &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;close(fd);&nbsp;//&nbsp;在之前关闭文件&nbsp;也没事&nbsp;因为映射到内存&nbsp;操作都是在内存中 &nbsp;&nbsp;&nbsp;&nbsp;printf("%s\n:&gt;",&nbsp;ptr); &nbsp;&nbsp;&nbsp;&nbsp;scanf("%s",ptr);&nbsp;//&nbsp;写的字符串超过之前文件的大小&nbsp;则后面超出的不写入文件 &nbsp;&nbsp;&nbsp;&nbsp;printf("%s\n",&nbsp;ptr); &nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg; }</code></pre> <p>运行：</p> <pre class="brush:bash;toolbar:false">[bozi@localhost&nbsp;test_2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg16http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg723]$&nbsp;./mmap aaaaaaaaaaa :&gt;asaaaaaaaasssssss&nbsp;&nbsp;&nbsp; asaaaaaaaasssssss [bozi@localhost&nbsp;test_2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg16http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg723]$&nbsp;cat&nbsp;mmap.tmp asaaaaaaaas[bozi@localhost&nbsp;test_2http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg16http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg723]$</pre> <p>&nbsp; &nbsp;只写入了文件大小的内容 后面超出的不写入</p> <p><span style="font-family:'微软雅黑', 'Microsoft YaHei';"></span></p> </div> </div> <p>转载于:https://blog.51cto.com/alick/183http://img.555519.xyz/uploads3/20220905/c648530a0b6dbaa3872aec7cfd30a859.jpg484</p> </div> 			                <div class="clearfix"></div>
                <div class="col-md-12 mt-5">
                                        <p>上一个：<a href="/news/article-54397.htm">猫打疫苗一共打几针要多少钱 猫打疫苗一共打几针要多少钱一针</a></p>
                                        <p>下一个：<a href="/news/article-54940.htm">AsyncLocal&lt;T&gt;在链路追踪中的应用_在线工具</a></p>
                                    </div>
                                </div>
                <div class="col-md-3">
                    <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">热门文章</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2"><a href="/free-nodes/2024-12-30-linux-clash-stash.htm" title="「12月30日」最高速度22.1M/S，2024年SSR/Clash/V2ray/Shadowrocket每天更新免费节点订阅链接">「12月30日」最高速度22.1M/S，2024年SSR/Clash/V2ray/Shadowrocket每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-1-1-free-high-speed-nodes.htm" title="「1月1日」最高速度20.8M/S，2025年Clash/SSR/Shadowrocket/V2ray每天更新免费节点订阅链接">「1月1日」最高速度20.8M/S，2025年Clash/SSR/Shadowrocket/V2ray每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-1-21-free-clash-subscribe.htm" title="「1月21日」最高速度18.5M/S，2025年V2ray/Clash/SSR/Shadowrocket每天更新免费节点订阅链接">「1月21日」最高速度18.5M/S，2025年V2ray/Clash/SSR/Shadowrocket每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-1-13-node-share.htm" title="「1月13日」最高速度22.3M/S，2025年V2ray/Clash/SSR/Shadowrocket每天更新免费节点订阅链接">「1月13日」最高速度22.3M/S，2025年V2ray/Clash/SSR/Shadowrocket每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-12-31-free-node-subscribe.htm" title="「12月31日」最高速度19.7M/S，2025年SSR/Shadowrocket/Clash/V2ray每天更新免费节点订阅链接">「12月31日」最高速度19.7M/S，2025年SSR/Shadowrocket/Clash/V2ray每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2024-12-24-clash-stash.htm" title="「12月24日」最高速度18.6M/S，2024年Clash/V2ray/Shadowrocket/SSR每天更新免费节点订阅链接">「12月24日」最高速度18.6M/S，2024年Clash/V2ray/Shadowrocket/SSR每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-2-22-free-shadowrocket-node.htm" title="「2月22日」最高速度21M/S，2025年SSR/V2ray/Clash/Shadowrocket每天更新免费节点订阅链接">「2月22日」最高速度21M/S，2025年SSR/V2ray/Clash/Shadowrocket每天更新免费节点订阅链接</a></li>
                        <li class="py-2"><a href="/news/article-27264.htm" title="动物医院仪器设备清单 动物医院仪器设备清单以及价格">动物医院仪器设备清单 动物医院仪器设备清单以及价格</a></li>
                        <li class="py-2"><a href="/news/article-58514.htm" title="佳雯宠物医院(环城东路分院)怎么样（佳雯宠物医院管理有限公司）">佳雯宠物医院(环城东路分院)怎么样（佳雯宠物医院管理有限公司）</a></li>
                        <li class="py-2"><a href="/free-nodes/2025-2-5-node-share.htm" title="「2月5日」最高速度21.8M/S，2025年SSR/Clash/Shadowrocket/V2ray每天更新免费节点订阅链接">「2月5日」最高速度21.8M/S，2025年SSR/Clash/Shadowrocket/V2ray每天更新免费节点订阅链接</a></li>
                    </ul>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">归纳</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">6</span> <a href="/date/2025-03/" title="2025-03 归档">2025-03</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">84</span> <a href="/date/2025-02/" title="2025-02 归档">2025-02</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">93</span> <a href="/date/2025-01/" title="2025-01 归档">2025-01</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">87</span> <a href="/date/2024-12/" title="2024-12 归档">2024-12</a></h4>
            </li>
                    </ul>
    </div>
</div>

                </div>
            </div>
        </div> <!-- .container -->
    </div> <!-- .page-section -->
        <footer class="page-footer bg-image" style="background-image: url(/assets/website/img/clashstash/world_pattern.svg);">
        <div class="container">
            <p class="text-center" id="copyright">
                            <p>
                                <a href="/">首页</a> | 
                                <a href="/free-node/">免费节点</a> | 
                                <a href="/news/">新闻资讯</a> |
                                <a href="/about-us.htm">关于我们</a> |
                                <a href="/disclaimer.htm">免责申明</a> |
                                <a href="/privacy.htm">隐私申明</a> |
                                <a href="/sitemap.xml">网站地图</a>
                            </p>
                <a href="/">ClashStash官方节点站</a> 版权所有
                <br />Powered by WordPress
            </p>
        </div>
    </footer>
    <script src="/assets/website/js/frontend/clashstash/jquery-3.5.1.min.js"></script>
    <script src="/assets/website/js/frontend/clashstash/bootstrap.bundle.min.js"></script>
    <script src="https://www.freeclashnode.com/assets/js/frontend/invite-url.js"></script><script src="/assets/website/js/frontend/G.js"></script>
</body>

</html>